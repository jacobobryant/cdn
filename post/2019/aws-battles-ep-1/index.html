<html><head><meta charset="utf-8" /><meta content="width=device-width, initial-scale=1" name="viewport" /><link crossorigin="anonymous" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" rel="stylesheet" /><link href="/css/custom.css" rel="stylesheet" /><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon" /><link href="/css/prism.css" rel="stylesheet" /><title>AWS Battles, Episode 1 | Jacob O'Bryant</title><meta content="Jacob O&apos;Bryant" name="author" /><meta content="AWS Battles, Episode 1 | Jacob O&apos;Bryant | Jacob O&apos;Bryant" name="description" /></head><body style="margin-bottom:20px;font-size:16px;font-family:&quot;Helvetica Neue&quot;,Helvetica,Arial,sans-serif"><nav class="navbar navbar-dark bg-dark navbar-expand-md"><div class="container"><ul class="navbar-nav"><li class="nav-item"><a class="navbar-brand" href="https://jacobobryant.com/" style="font-size:22px">Jacob O'Bryant</a></li><li class="nav-item active"><a class="nav-link" href="https://jacobobryant.com/" style="font-size:18px">Articles</a></li><li class="nav-item "><a class="nav-link" href="https://jacobobryant.com/recommendations/" style="font-size:18px">Recommendations</a></li><li class="nav-item "><a class="nav-link" href="https://jacobobryant.com/about/" style="font-size:18px">About</a></li></ul></div></nav><div style="width:25px;height:25px"></div><div class="container"><div class="row"><div class="col-lg-2 d-flex flex-row flex-lg-column align-items-center align-items-lg-start mb-3" style="font-size:14px"><img src="/about/avatar.jpg" width="130px" /><div style="width:20px;height:10px"></div><div><div>Founder @ <a href="https://lagukan.com" target="_blank">Lagukan</a></div><div style="width:5px;height:5px"></div><div><a href="https://tinyletter.com/jacobobryant" target="_blank">Subscribe</a> (<a href="https://jacobobryant.com/atom.xml" target="_blank">feed</a>)</div><div style="width:5px;height:5px"></div><div><a href="https://twitter.com/obryant666" target="_blank">Twitter</a></div></div></div><div class="col-lg" style="max-width:600px"><h3>AWS Battles, Episode 1</h3><p>December 2019</p><p>I'm starting a new series. Whenever I start thinking about how much work it might take to ditch AWS and Datomic Ions and set up Datomic On-Prem on DigitalOcean instead, I'm going to write a blog post about what happened.</p><p>I made the mistake of trying to deploy code to my Datomic system today. As usual, the deploy failed shortly after initiating it:</p><pre><code class="lang-bash">$ iondeploy  # My deploy script. It prints the status every 3 seconds.
...
{:deploy-status &quot;RUNNING&quot;, :code-deploy-status &quot;RUNNING&quot;}
{:deploy-status &quot;RUNNING&quot;, :code-deploy-status &quot;RUNNING&quot;}
{:deploy-status &quot;RUNNING&quot;, :code-deploy-status &quot;RUNNING&quot;}
{:deploy-status &quot;RUNNING&quot;, :code-deploy-status &quot;RUNNING&quot;}
{:deploy-status &quot;RUNNING&quot;, :code-deploy-status &quot;RUNNING&quot;}
{:deploy-status &quot;FAILED&quot;, :code-deploy-status &quot;FAILED&quot;}
</code></pre><p>A successful deploy usually has about 15 status lines. If it fails after four or five lines, that means the deploy had an out-of-memory error. (If there are 30+ status lines before failure, that means it's the dreaded arggh-<code>ValidateService</code>-failed-again error).</p><p>Usually, at this point I would log into the EC2 console, terminate the compute instance, wait for the auto scaling group to bring another instance up, and then deploy (and sigh wistfully... "if only the solo topology didn't use a weenie <code>t3.small</code> instance"). But since this is a near-daily occurrence for me, I decided to figure out how to terminate the instance using the AWS CLI instead.</p><p>Here's the result (thanks <a href="https://github.com/borkdude/babashka">Borkdude</a>!):</p><pre><code class="lang-clojure">#!/bin/bash
# vim: ft=clojure
id=$(aws ec2 describe-instances | bb -i &apos;
(-&gt;&gt; *input*
     (str/join &quot;&quot;)
     (#(json/parse-string % true))
     :Reservations
     (mapcat :Instances)
     (filter (fn [{:keys [Tags]}]
               (-&gt;&gt; Tags
                    (filter #(= &quot;Name&quot; (:Key %)))
                    first
                    :Value
                    (= &quot;bud&quot;))))
     first
     :InstanceId
     println)&apos;)

aws ec2 terminate-instances --instance-ids $id
watch aws ec2 describe-instance-status
</code></pre><p>("bud" is my Datomic application name, chosen because the first app I made on this system was a budgeting app. It may not have any meaning now, but at least it's short and easy to remember, like all good variable names.)</p><p>Something went wrong though. Maybe there's some kind of difference between terminating an instance from the command line or from the EC2 console, although my guess is it was just a coincidence. Fate is punishing me for my existence. Anyway, the instances kept dying whenever the auto scaling group tried to bring another one up:</p><p><img alt="ec2 console" src="/img/ec2-console.jpg" /></p><p>It was stuck in a loop of trying to boot instances only to have them come dead-on-arrival. Actually that wouldn't normally be a problem: I noticed recently that often, the first one or two new instances would die, followed by a successfully booted instance. But this time they just kept dying, as if it was some kind of zombie apocalypse.</p><p>Today I learned that you can easily view the system logs for an instance from the EC2 console (under Actions -> Instance Settings -> Get System Log), after which I found the culprit:</p><pre><code class="lang-bash">login: /dev/fd/11: line 1: /sbin/plymouthd: No such file or directory
</code></pre><p>I don't know what the deal with that is, but I searched for the error, and someone on StackExchange said it was because something was wrong with something else, so I decided to try deleting and re-creating the CloudFormation stack. I wasn't sure if that was an OK thing to do or not (I'm not exactly an AWS expert, in case you haven't already guessed), but I checked the <a href="https://docs.datomic.com/cloud/operation/deleting.html#deleting-stacks">Datomic docs</a>, and huzzah, it is an OK thing to do.</p><p>One stack deletion later, I find that my compute stack is stuck in a <code>DELETE_IN_PROGRESS</code> state. Boo. I did a search for force-deleting a stack and found <a href="https://forums.aws.amazon.com/thread.jspa?threadID=148754&amp;start=0&amp;tstart=0">this thread</a> on the AWS forums. It contained the sad tale of Eric, an AWS customer trying to do something that wasn't working. Halfway down the page, and after several usages of the word "unacceptable," I felt like I was right there with Eric. "Yeah, I hate AWS too!" (Maybe 2020 will be the year of Datomic-Cloud-Ions-on-the-Firebase).</p><p>Fortunately, the very last post in that thread (from just last October, five years after Eric's original post—hopefully his stack has finished deleting by now) contained a link to <a href="https://aws.amazon.com/premiumsupport/knowledge-center/cloudformation-lambda-resource-delete/">a document</a> for troubleshooting this very issue. Hallelujah.</p><p>It had two sections, one for fixing <code>DELETE_FAILED</code> and one for fixing <code>DELETE_IN_PROGRESS</code>. I went to the latter section. Everything was going great until about halfway through step 1. I had downloaded Datomic's CloudFormation template, I did a search for <code>ServiceToken</code>... and got five or seven results, with no idea how to <code>identify the name of the Lambda function where your custom resource is sending requests</code>. Maybe I should just pick one? There were a couple that had "Delete" in the name, that sounds promising....</p><p>I was saved by the bell. I switched back to the CloudFormation console and found that my stack had switched from <code>DELETE_IN_PROGRESS</code> to <code>DELETE_FAILED</code>. That meant I could try the other set of instructions! My heart soared. (Well, it at least picked up a little). The instructions for fixing <code>DELETE_FAILED</code> were much simpler. I was confronted with a dialog and two checkboxes and a charge to <code>choose the custom resource that&apos;s stuck in the DELETE_FAILED status</code>. Unsure of which one to pick, I selected both of them (I think... or maybe I left both of them unselected. I think I selected them though). After that, the stack finally deleted. The worst was over.</p><p>Then it was just a little cleanup. I <a href="https://docs.datomic.com/cloud/getting-started/configuring-access.html#authorize-gateway">re-enabled SSH access to the bastion</a>, re-deployed my Datomic application (successfully!), and then fiddled with API Gateway until it forwarded requests to the newly created Lambdas. That involved deleting-and-recreating the Lambda proxy resource for each API while muttering the correct incantations so as not to offend the CORS gods.</p><p>At last, after only two-ish hours of down-time, the three apps I'm hosting on Datomic are up and running again. Well, not including <a href="https://notjust.us">one of them</a>— I'm still waiting on a bugfix before that one will work again. :)</p><hr /><p class="small">There's more where that came from if you <a href="https://tinyletter.com/jacobobryant" target="_blank">subscribe</a> to my newsletter.</p></div></div></div><script type="text/javascript">
 var sc_project=12140644;
 var sc_invisible=1;
 var sc_security="e36ded0c";
 var sc_https=1;
 var sc_remove_link=1;
 </script>
 <script type="text/javascript"
 src="https://www.statcounter.com/counter/counter.js"
 async></script>
 <noscript><div class="statcounter"><img class="statcounter"
 src="https://c.statcounter.com/12140644/0/e36ded0c/1/"
 alt="site stats"></div></noscript><script src="/js/prism.js"></script></body></html>